<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skener Fakt√∫r ‚Äî Pansk√° 17</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1017;--bg2:#13141d;--bg3:#181926;--border:#1c1e2e;--border2:#252838;
--text:#cdd0dc;--text2:#8b8fa3;--text3:#636987;--text4:#4e5268;
--white:#f0f0f0;--purple:#a78bfa;--blue:#2563eb;--violet:#7c3aed;
--green:#22c55e;--red:#f87171;--yellow:#eab308}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--purple)}
.header{border-bottom:1px solid var(--border);background:linear-gradient(180deg,#15161f,var(--bg))}
.header-inner{max-width:1200px;margin:0 auto;padding:18px 24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--violet),var(--blue));display:flex;align-items:center;justify-content:center;box-shadow:0 2px 16px rgba(124,58,237,0.3)}
.h1{font-size:18px;font-weight:700;color:var(--white);letter-spacing:-0.3px}
.tagline{font-size:12px;color:var(--text3)}
.main{max-width:1200px;margin:0 auto;padding:28px 24px}
.api-bar{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:20px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.api-bar label{font-size:13px;color:var(--text2);white-space:nowrap}
.api-bar input{flex:1;min-width:200px;padding:8px 14px;border-radius:8px;border:1px solid var(--border2);background:var(--bg);color:var(--text);font-family:'JetBrains Mono',monospace;font-size:13px;outline:none}
.api-bar input:focus{border-color:var(--violet)}
.api-bar .hint{font-size:11px;color:var(--text4);width:100%}
.api-bar .saved{font-size:12px;color:var(--green);display:none}
.drop{border:2px dashed var(--border2);border-radius:16px;padding:56px 24px;text-align:center;cursor:pointer;background:var(--bg2);transition:border-color 0.2s}
.drop.over{border-color:var(--violet);background:#14152a}
.drop-title{font-size:17px;font-weight:500;color:#9ca0b8;margin:14px 0 6px}
.drop-sub{font-size:13px;color:var(--text4);margin-bottom:16px}
.badges{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.badge{font-size:11px;padding:3px 10px;border-radius:6px;background:#1a1d2e;color:var(--text3);font-weight:600}
.badge.ok{background:#1a3a2a;color:#4ade80}
.panel{background:var(--bg2);border-radius:14px;border:1px solid var(--border);overflow:hidden}
.panel-head{padding:18px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px}
.panel-title{font-size:16px;font-weight:600;color:var(--white)}
.panel-sub{font-size:12px;color:var(--text3);margin-top:2px}
.btn{padding:9px 22px;border-radius:9px;font-size:14px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;border:none}
.btn:hover{opacity:0.85}
.btn-primary{background:linear-gradient(135deg,var(--violet),var(--blue));color:#fff}
.btn-stop{border:1px solid #7f1d1d;background:rgba(127,29,29,0.2);color:var(--red)}
.btn-sm{padding:6px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;border:none}
.btn-save{background:var(--green);color:#000}
.btn-cancel{background:transparent;border:1px solid var(--border2);color:var(--text2)}
.btn-edit{background:transparent;border:1px solid var(--border2);color:var(--purple);cursor:pointer;padding:5px 12px;border-radius:7px;font-size:12px;font-family:inherit}
.btn-del{background:transparent;border:1px solid #7f1d1d;color:var(--red);cursor:pointer;padding:5px 12px;border-radius:7px;font-size:12px;font-family:inherit}
.btn-add{background:rgba(124,58,237,0.1);border:1px dashed var(--violet);color:var(--purple);cursor:pointer;padding:6px 14px;border-radius:7px;font-size:12px;font-family:inherit;width:100%;margin-top:8px}
.btn-reset{padding:7px 16px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:var(--text2);font-size:13px;cursor:pointer;font-family:inherit}
.btn-danger{padding:7px 16px;border-radius:8px;border:1px solid #7f1d1d;background:transparent;color:var(--red);font-size:13px;cursor:pointer;font-family:inherit}
.btn-excel{display:flex;align-items:center;gap:6px;padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(135deg,#166534,#15803d);color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit}
.btn-html{display:flex;align-items:center;gap:6px;padding:10px 18px;border-radius:10px;border:none;background:linear-gradient(135deg,#9333ea,#7c3aed);color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit}
.prog-wrap{padding:12px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.prog-bar{flex:1;height:6px;border-radius:3px;background:var(--border);overflow:hidden}
.prog-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--violet),var(--blue));transition:width 0.4s ease}
.prog-text{font-size:12px;color:var(--text3);font-family:'JetBrains Mono',monospace;min-width:80px;text-align:right}
.file-list{max-height:320px;overflow-y:auto}
.file-row{display:flex;align-items:center;gap:10px;padding:9px 20px;border-bottom:1px solid #141520;font-size:13px}
.file-row.active{background:rgba(124,58,237,0.08)}.file-row.done{opacity:0.6}.file-row.err{background:rgba(127,29,29,0.08)}
.file-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-size{font-size:11px;color:var(--text4);font-family:'JetBrains Mono',monospace}
.check{color:var(--green);font-weight:700}.err-mark{color:var(--red);font-weight:700}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:14px;height:14px;border:2px solid rgba(124,58,237,0.2);border-top-color:var(--purple);border-radius:50%;animation:spin 0.7s linear infinite;display:inline-block;flex-shrink:0}
.stats-bar{display:flex;gap:12px;align-items:stretch;margin-bottom:20px;flex-wrap:wrap}
.stat{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:flex;flex-direction:column;gap:2px;flex:1;min-width:100px}
.stat-v{font-size:22px;font-weight:700;color:var(--white);font-family:'JetBrains Mono',monospace}
.stat-l{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px}
.t-wrap{border-radius:12px;border:1px solid var(--border);overflow:auto;background:var(--bg2)}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:11px 14px;background:var(--bg3);color:var(--text3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border);position:sticky;top:0}
td{padding:10px 14px;border-bottom:1px solid #141520;color:var(--text)}
tr.clickable{cursor:pointer}tr.clickable:hover{background:rgba(124,58,237,0.04)}
tr.alt{background:rgba(28,30,46,0.3)}
.mono{font-family:'JetBrains Mono',monospace;font-size:12px}
.t-badge{font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600}
.t-pdf{background:rgba(239,68,68,0.12);color:var(--red)}.t-img{background:rgba(96,165,250,0.12);color:#60a5fa}
.t-multi{background:rgba(167,139,250,0.12);color:var(--purple);font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;margin-left:4px}
.detail{margin-top:16px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;animation:fadeIn 0.25s ease}
.detail-split{display:grid;grid-template-columns:1fr 1fr;min-height:400px}
.detail-original{border-right:1px solid var(--border);background:var(--bg);display:flex;flex-direction:column}
.detail-original-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.detail-original-body{flex:1;overflow:auto;display:flex;align-items:flex-start;justify-content:center;padding:12px}
.detail-original-body img{max-width:100%;height:auto;border-radius:4px;transition:transform 0.3s}
.detail-original-body iframe{width:100%;height:100%;min-height:550px;border:none}
.detail-data{padding:20px;overflow-y:auto;max-height:800px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.dh4{margin:0 0 8px;font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;font-weight:600}
.field{display:flex;gap:6px;margin-bottom:3px;align-items:center}.f-label{font-size:12px;color:var(--text4);min-width:70px}.f-val{font-size:13px;color:var(--text)}
.edit-input{padding:4px 8px;border-radius:5px;border:1px solid var(--border2);background:var(--bg);color:var(--white);font-family:'JetBrains Mono',monospace;font-size:12px;width:100%;outline:none}
.edit-input:focus{border-color:var(--violet)}
.edit-input.sm{width:80px}
.totals-box{background:var(--bg3);border-radius:10px;padding:14px 16px;border:1px solid var(--border)}
.tot-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:var(--text2)}
.notes-box{background:var(--bg3);border-radius:10px;padding:14px 16px;border:1px solid var(--border)}
.db-bar{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px 20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.db-info{font-size:13px;color:var(--text2)}.db-info strong{color:var(--white)}
.db-actions{display:flex;gap:8px;flex-wrap:wrap}
.rot-controls{display:flex;gap:4px;align-items:center}
.rot-btn{width:28px;height:28px;border-radius:6px;border:1px solid var(--border2);background:var(--bg2);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px}
.rot-btn:hover{border-color:var(--violet);color:var(--purple)}
.edit-toolbar{display:flex;gap:6px;padding:12px 20px;background:rgba(124,58,237,0.06);border-bottom:1px solid rgba(124,58,237,0.15);align-items:center;flex-wrap:wrap}
.edit-toolbar .info{font-size:12px;color:var(--purple);flex:1}
.item-row-edit{display:grid;grid-template-columns:1fr 60px 80px 80px 30px;gap:6px;align-items:center;margin-bottom:4px}
.item-row-edit input{padding:5px 8px;border-radius:5px;border:1px solid var(--border2);background:var(--bg);color:var(--white);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none}
.item-row-edit input:focus{border-color:var(--violet)}
.item-del{width:26px;height:26px;border-radius:5px;border:1px solid #7f1d1d;background:transparent;color:var(--red);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:800px){.detail-split{grid-template-columns:1fr}.detail-grid{grid-template-columns:1fr}.stats-bar{flex-direction:column}.item-row-edit{grid-template-columns:1fr 50px 70px 70px 28px}}
.hidden{display:none!important}
</style>
</head>
<body>
<header class="header"><div class="header-inner">
<div class="brand"><div class="logo"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="9" y1="13" x2="15" y2="13"/><line x1="9" y1="17" x2="13" y2="17"/></svg></div>
<div><div class="h1">Skener Fakt√∫r</div><div class="tagline">AI extrakcia + ruƒçn√° korekcia ‚Üí Excel / HTML</div></div></div>
<button class="btn-reset hidden" id="resetBtn" onclick="resetAll()">Nov√Ω batch</button>
</div></header>
<main class="main">
<div class="api-bar"><label for="apiKey">API kƒæ√∫ƒç:</label><input type="password" id="apiKey" placeholder="sk-ant-..." oninput="saveKey()"><span class="saved" id="keySaved">‚úì</span><div class="hint">Kƒæ√∫ƒç sa uklad√° len vo va≈°om prehliadaƒçi. <a href="https://console.anthropic.com/settings/keys" target="_blank">Z√≠ska≈• kƒæ√∫ƒç</a></div></div>
<div class="db-bar hidden" id="dbBar"><div class="db-info">Ulo≈æen√©: <strong id="dbCount">0</strong> dokladov</div><div class="db-actions"><button class="btn-excel" onclick="loadAndExcel()">Excel</button><button class="btn-html" onclick="loadAndHtml()">HTML Report</button><button class="btn-reset" onclick="showSaved()">Zobrazi≈•</button><button class="btn-danger" onclick="clearDb()">Vymaza≈• v≈°etko</button></div></div>
<div class="drop" id="dropZone" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="handleDrop(event)" onclick="document.getElementById('fileInput').click()">
<input type="file" id="fileInput" accept="image/jpeg,image/png,image/gif,image/webp,application/pdf" multiple style="display:none" onchange="handleFileSelect(this.files)">
<svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="#636987" stroke-width="1.2" style="opacity:0.5"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><line x1="12" y1="11" x2="12" y2="17"/><polyline points="9 14 12 11 15 14"/></svg>
<p class="drop-title">Pretiahnite s√∫bory alebo kliknite</p><p class="drop-sub">AI rozozn√° d√°ta, vy ich ƒæahko oprav√≠te</p>
<div class="badges"><span class="badge">PDF</span><span class="badge">JPG</span><span class="badge">PNG</span><span class="badge ok">Viac dokladov ‚úì</span><span class="badge ok">Otoƒçen√© ‚úì</span><span class="badge ok">Editovateƒæn√© ‚úì</span></div>
</div>
<div class="panel hidden" id="processPanel"><div class="panel-head"><div><div class="panel-title" id="fileCount"></div><div class="panel-sub" id="fileTypes"></div></div><div style="display:flex;gap:8px"><button class="btn btn-primary" id="startBtn" onclick="processAll()">Spracova≈•</button><button class="btn btn-stop hidden" id="stopBtn" onclick="stopProcessing()">Stop</button></div></div><div class="prog-wrap hidden" id="progressWrap"><div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div><span class="prog-text" id="progText">0/0</span></div><div class="file-list" id="fileList"></div></div>
<div class="hidden" id="resultsSection"><div class="stats-bar" id="statsBar"></div><div class="t-wrap"><table id="resultsTable"></table></div><div id="detailPanel"></div></div>
</main>
<script>
// ===== IndexedDB =====
const DB='ScannerDB',ST='invoices',DBV=2;
function openDb(){return new Promise((ok,no)=>{const r=indexedDB.open(DB,DBV);r.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(ST))db.createObjectStore(ST,{keyPath:'id',autoIncrement:true})};r.onsuccess=()=>ok(r.result);r.onerror=()=>no(r.error)})}
async function dbSave(item){const db=await openDb();return new Promise((ok,no)=>{const tx=db.transaction(ST,'readwrite');const req=tx.objectStore(ST).add(item);req.onsuccess=()=>{item.id=req.result;ok(item.id)};tx.onerror=()=>no(tx.error)})}
async function dbUpdate(item){const db=await openDb();return new Promise((ok,no)=>{const tx=db.transaction(ST,'readwrite');tx.objectStore(ST).put(item);tx.oncomplete=()=>ok();tx.onerror=()=>no(tx.error)})}
async function dbDelete(id){const db=await openDb();return new Promise((ok,no)=>{const tx=db.transaction(ST,'readwrite');tx.objectStore(ST).delete(id);tx.oncomplete=()=>{ok();updateDbBar()};tx.onerror=()=>no(tx.error)})}
async function dbGetAll(){const db=await openDb();return new Promise((ok,no)=>{const r=db.transaction(ST,'readonly').objectStore(ST).getAll();r.onsuccess=()=>ok(r.result);r.onerror=()=>no(r.error)})}
async function dbClear(){const db=await openDb();return new Promise((ok,no)=>{const tx=db.transaction(ST,'readwrite');tx.objectStore(ST).clear();tx.oncomplete=()=>{ok();updateDbBar()};tx.onerror=()=>no(tx.error)})}
async function updateDbBar(){try{const a=await dbGetAll();document.getElementById('dbCount').textContent=a.length;document.getElementById('dbBar').classList.toggle('hidden',!a.length)}catch(e){}}

// ===== Prompt =====
const PROMPT = `You are a precise receipt and invoice data extractor specializing in Slovak and Czech documents.

STEP 1 - ORIENTATION: Determine if image is rotated. Set image_rotation (0/90/180/270).
STEP 2 - COUNT DOCUMENTS: Each physically separate piece of paper = separate document.  
STEP 3 - EXTRACT each document INDEPENDENTLY. Do NOT mix data between documents.

SLOVAK RECEIPT STRUCTURE (bloƒçok/√∫ƒçtenka):
- HEADER: Store name, address, IƒåO, DIƒå, Iƒå DPH
- ITEMS: Product names with prices = ACTUAL PURCHASED GOODS
- TOTAL: "SPOLU" or "CELKOM" = purchase price
- PAYMENT (NOT items): "NA √öHRADU", "HOTOVOS≈§", "VR√ÅTI≈§", "DOPLATI≈§", "ZAOKR√öHLENIE", "PLATBA KARTOU"

"PR√çJMOV√ù POKLADNIƒåN√ù DOKLAD" = handwritten cash receipt:
- "Prijal od" = payer name, "Spolu EUR" = total, "√öƒçel" = purpose. Read handwritten numbers carefully!

‚úÖ Items = actual products/services purchased
‚ùå NOT items: HOTOVOS≈§, VR√ÅTI≈§, NA √öHRADU, DOPLATI≈§, ZAOKR√öHLENIE, bank names, addresses

Return ONLY a JSON array:
[{"document_index":1,"image_rotation":0,"vendor":"name","vendor_address":"addr","date":"YYYY-MM-DD","time":"HH:MM or null","currency":"EUR","items":[{"description":"product","quantity":1,"unit_price":0.00,"total":0.00}],"subtotal":0.00,"tax_rate":"20% or null","tax_amount":0.00,"total":0.00,"payment_method":"cash/card/transfer","invoice_number":"or null","ico":"or null","dic":"or null","ic_dph":"or null","iban":"or null","due_date":"or null","order_number":"or null","receipt_number":"or null","notes":"payment details, rounding","confidence":"high/medium/low","language":"Slovak"}]

Rules: ALWAYS array. total = purchase amount NOT cash tendered. Each paper = separate object. No markdown.`;

// ===== State =====
let files=[],results=[],fileErrors=[],aborted=false,selectedIdx=null,editMode=false;
const isPDF=f=>f.type==='application/pdf',isImage=f=>['image/jpeg','image/png','image/gif','image/webp'].includes(f.type),isValid=f=>isPDF(f)||isImage(f);
const fmt=n=>n!=null?Number(n).toLocaleString('sk-SK',{minimumFractionDigits:2}):'‚Äî';
const field=(l,v)=>v!=null&&v!==''?`<div class="field"><span class="f-label">${l}</span><span class="f-val">${v}</span></div>`:'';
const eField=(l,key,val,cls)=>`<div class="field"><span class="f-label">${l}</span><input class="edit-input ${cls||''}" data-key="${key}" value="${val!=null?val:''}" /></div>`;

function saveKey(){const k=document.getElementById('apiKey').value;if(k)try{localStorage.setItem('anthropic_key',k)}catch(e){}const s=document.getElementById('keySaved');s.style.display='inline';setTimeout(()=>s.style.display='none',1500)}
try{const s=localStorage.getItem('anthropic_key');if(s)document.getElementById('apiKey').value=s}catch(e){}
function fileToBase64(f){return new Promise((r,e)=>{const rd=new FileReader();rd.onload=()=>r(rd.result);rd.onerror=()=>e(new Error('Read failed'));rd.readAsDataURL(f)})}

// ===== File handling =====
function handleDrop(e){e.preventDefault();e.currentTarget.classList.remove('over');const items=e.dataTransfer.items;if(items){const p=[];for(let i=0;i<items.length;i++){const entry=items[i].webkitGetAsEntry?.();if(entry)p.push(traverseEntry(entry));else{const f=items[i].getAsFile();if(f)p.push(Promise.resolve([f]))}}Promise.all(p).then(a=>handleFileSelect(a.flat()))}else handleFileSelect(e.dataTransfer.files)}
function traverseEntry(entry){return new Promise(resolve=>{if(entry.isFile)entry.file(f=>resolve([f]));else if(entry.isDirectory){const reader=entry.createReader(),all=[];const read=()=>reader.readEntries(entries=>{if(!entries.length)Promise.all(all.map(traverseEntry)).then(r=>resolve(r.flat()));else{all.push(...entries);read()}});read()}else resolve([])})}
function handleFileSelect(fl){const v=Array.from(fl).filter(isValid);if(!v.length)return;v.sort((a,b)=>a.name.localeCompare(b.name));files=v;results=[];fileErrors=[];selectedIdx=null;editMode=false;
$('dropZone').classList.add('hidden');$('processPanel').classList.remove('hidden');$('resetBtn').classList.remove('hidden');$('resultsSection').classList.add('hidden');
$('fileCount').textContent=`${files.length} ${files.length===1?'s√∫bor':files.length<5?'s√∫bory':'s√∫borov'}`;
$('fileTypes').textContent=[files.filter(isPDF).length&&files.filter(isPDF).length+' PDF',files.filter(isImage).length&&files.filter(isImage).length+' obr√°zkov'].filter(Boolean).join(' ¬∑ ');renderFileList()}
function renderFileList(){$('fileList').innerHTML=files.map((f,i)=>{const done=results.some(r=>r._filename===f.name);const err=fileErrors.some(e=>e.file===f.name);
return`<div class="file-row ${done?'done':''} ${err?'err':''}" id="frow-${i}">${isPDF(f)?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}<span class="file-name">${f.name}</span><span class="file-size">${(f.size/1024).toFixed(0)} KB</span>${done?'<span class="check">‚úì</span>':err?'<span class="err-mark">‚úó</span>':''}</div>`}).join('')}

// ===== Processing =====
async function processAll(){const key=$('apiKey').value.trim();if(!key){alert('Zadajte API kƒæ√∫ƒç.');return}
aborted=false;results=[];fileErrors=[];$('startBtn').classList.add('hidden');$('stopBtn').classList.remove('hidden');$('progressWrap').classList.remove('hidden');$('resultsSection').classList.add('hidden');
for(let i=0;i<files.length;i++){if(aborted)break;const row=$('frow-'+i);if(row){row.classList.add('active');row.innerHTML=row.innerHTML.replace(/<\/div>$/,'<span class="spinner"></span></div>')}updProg();
try{const du=await fileToBase64(files[i]);const b=du.split(',')[1];
const ct=isPDF(files[i])?[{type:'document',source:{type:'base64',media_type:'application/pdf',data:b}},{type:'text',text:PROMPT}]:[{type:'image',source:{type:'base64',media_type:files[i].type,data:b}},{type:'text',text:PROMPT}];
const rsp=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:4000,messages:[{role:'user',content:ct}]})});
const data=await rsp.json();if(data.error)throw new Error(data.error.message);
const txt=data.content.map(c=>c.type==='text'?c.text:'').filter(Boolean).join('\n');
let parsed=JSON.parse(txt.replace(/```json|```/g,'').trim());
if(!Array.isArray(parsed))parsed=[parsed];
const rot=parsed[0]?.image_rotation||0;
for(let di=0;di<parsed.length;di++){const doc=parsed[di];doc._filename=files[i].name;doc._fileType=isPDF(files[i])?'PDF':'Image';doc._originalDataUrl=du;doc._originalMediaType=files[i].type;doc._timestamp=new Date().toISOString();doc._rotation=rot;doc._docIndex=di+1;doc._docsInFile=parsed.length;doc._displayName=parsed.length>1?`${files[i].name} [${di+1}/${parsed.length}]`:files[i].name;
const newId=await dbSave({...doc});doc.id=newId;results.push(doc)}
}catch(err){fileErrors.push({file:files[i].name,error:err.message})}
renderFileList();updProg();if(i<files.length-1)await new Promise(r=>setTimeout(r,800))}
$('stopBtn').classList.add('hidden');showResults();updateDbBar()}
function stopProcessing(){aborted=true}
function updProg(){const c=results.length+fileErrors.length;const p=files.length?Math.round(c/files.length*100):0;$('progFill').style.width=p+'%';$('progText').textContent=`${c}/${files.length}`}

async function showSaved(){try{const all=await dbGetAll();if(!all.length){alert('≈Ωiadne ulo≈æen√© doklady.');return}results=all;fileErrors=[];$('dropZone').classList.add('hidden');$('processPanel').classList.add('hidden');$('resetBtn').classList.remove('hidden');showResults()}catch(e){alert('Chyba: '+e.message)}}
async function clearDb(){if(!confirm('Vymaza≈• v≈°etky ulo≈æen√© doklady?'))return;await dbClear();results=[];$('resultsSection').classList.add('hidden')}
async function loadAndExcel(){results=await dbGetAll();if(!results.length)return alert('≈Ωiadne d√°ta.');generateExcel()}
async function loadAndHtml(){results=await dbGetAll();if(!results.length)return alert('≈Ωiadne d√°ta.');generateHtmlReport()}

// ===== Results =====
function showResults(){if(!results.length)return;$('resultsSection').classList.remove('hidden');selectedIdx=null;editMode=false;
const ts=results.reduce((s,r)=>s+(r.total||0),0);const cur=[...new Set(results.map(r=>r.currency).filter(Boolean))];const ti=results.reduce((s,r)=>s+(r.items?.length||0),0);
const td=cur.length<=1?`${fmt(ts)} ${cur[0]||''}`:cur.map(c=>`${fmt(results.filter(r=>r.currency===c).reduce((s,r)=>s+(r.total||0),0))} ${c}`).join(' ¬∑ ');
$('statsBar').innerHTML=`<div class="stat"><span class="stat-v">${[...new Set(results.map(r=>r._filename))].length}</span><span class="stat-l">S√∫borov</span></div><div class="stat"><span class="stat-v">${results.length}</span><span class="stat-l">Dokladov</span></div>${fileErrors.length?`<div class="stat" style="border-color:#7f1d1d"><span class="stat-v" style="color:var(--red)">${fileErrors.length}</span><span class="stat-l">Chyby</span></div>`:''}<div class="stat"><span class="stat-v">${ti}</span><span class="stat-l">Polo≈æiek</span></div><div class="stat" style="flex:1.5"><span class="stat-v" style="color:var(--purple)">${td}</span><span class="stat-l">Celkom</span></div><button class="btn-excel" onclick="generateExcel()">Excel</button><button class="btn-html" onclick="generateHtmlReport()">HTML Report</button>`;
renderTable()}

function renderTable(){
let h='<thead><tr><th>S√∫bor</th><th>Dod√°vateƒæ</th><th>D√°tum</th><th>ƒå. dokladu</th><th style="text-align:right">Celkom</th><th>Mena</th><th style="text-align:center">Pol.</th><th></th></tr></thead><tbody>';
results.forEach((r,i)=>{h+=`<tr class="clickable${i%2?' alt':''}" onclick="toggleDetail(${i})"><td><span class="mono">${r._displayName||r._filename||'‚Äî'}</span></td><td>${r.vendor||'‚Äî'}</td><td class="mono">${r.date||'‚Äî'}</td><td class="mono">${r.invoice_number||r.receipt_number||'‚Äî'}</td><td style="text-align:right" class="mono"><b>${fmt(r.total)}</b></td><td>${r.currency||'‚Äî'}</td><td style="text-align:center">${r.items?.length||0}</td><td style="text-align:center;color:var(--text3)" id="arrow-${i}">‚ñº</td></tr>`});
h+='</tbody>';$('resultsTable').innerHTML=h;$('detailPanel').innerHTML=''}

function toggleDetail(idx){const panel=$('detailPanel');if(selectedIdx===idx&&!editMode){selectedIdx=null;panel.innerHTML='';$('arrow-'+idx).textContent='‚ñº';return}
if(selectedIdx!==null&&selectedIdx!==idx)$('arrow-'+selectedIdx).textContent='‚ñº';selectedIdx=idx;$('arrow-'+idx).textContent='‚ñ≤';editMode=false;renderDetail(idx)}

function renderDetail(idx){
const d=results[idx];const cc={high:'var(--green)',medium:'var(--yellow)',low:'var(--red)'};const rot=d._rotation||0;const isP=d._originalMediaType==='application/pdf';
let orig='<div style="padding:40px;text-align:center;color:var(--text4)">Origin√°l nie je dostupn√Ω</div>';
if(d._originalDataUrl){if(isP)orig=`<iframe src="${d._originalDataUrl}"></iframe>`;else orig=`<img id="orig-img-${idx}" src="${d._originalDataUrl}" style="transform:rotate(${rot}deg)">`}
const rotC=!isP&&d._originalDataUrl?`<div class="rot-controls"><button class="rot-btn" onclick="event.stopPropagation();rotImg(${idx},-90)">‚Ü∂</button><button class="rot-btn" onclick="event.stopPropagation();rotImg(${idx},90)">‚Ü∑</button><button class="rot-btn" onclick="event.stopPropagation();rotImg(${idx},180)">‚áÖ</button></div>`:'';
let items='';if(d.items?.length){items=`<div style="margin-top:16px"><h4 class="dh4">Polo≈æky (${d.items.length})</h4><div style="border-radius:8px;border:1px solid var(--border);overflow:auto"><table><thead><tr><th style="padding:8px 12px">Popis</th><th style="padding:8px 12px;text-align:right">Mn.</th><th style="padding:8px 12px;text-align:right">Jedn.</th><th style="padding:8px 12px;text-align:right">Spolu</th></tr></thead><tbody>${d.items.map(it=>`<tr><td style="padding:7px 12px">${it.description}</td><td style="padding:7px 12px;text-align:right" class="mono">${it.quantity}</td><td style="padding:7px 12px;text-align:right" class="mono">${fmt(it.unit_price)}</td><td style="padding:7px 12px;text-align:right;font-weight:600" class="mono">${fmt(it.total)}</td></tr>`).join('')}</tbody></table></div></div>`}
const multi=(d._docsInFile||1)>1?`<div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.2);border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:12px;color:var(--purple)">Doklad ${d._docIndex} z ${d._docsInFile} v s√∫bore ${d._filename}</div>`:'';

$('detailPanel').innerHTML=`<div class="detail">
<div class="edit-toolbar"><span class="info">Kliknite Upravi≈• pre korekciu AI extrakcie</span><button class="btn-edit" onclick="startEdit(${idx})">‚úèÔ∏è Upravi≈•</button><button class="btn-del" onclick="deleteInvoice(${idx})">üóë Zmaza≈•</button></div>
<div class="detail-split"><div class="detail-original"><div class="detail-original-head"><span class="dh4" style="margin:0">Origin√°l</span>${rotC}<span class="mono" style="color:var(--text4)">${d._displayName||d._filename}</span></div><div class="detail-original-body">${orig}</div></div>
<div class="detail-data">${multi}<div class="detail-grid"><div><h4 class="dh4">Dod√°vateƒæ</h4>${field('N√°zov',d.vendor)}${field('Adresa',d.vendor_address)}${field('IƒåO',d.ico)}${field('DIƒå',d.dic)}${field('Iƒå DPH',d.ic_dph)}${field('IBAN',d.iban)}</div>
<div><h4 class="dh4">Dokument</h4>${field('D√°tum',d.date)}${field('Splatnos≈•',d.due_date)}${field('ƒå. dokladu',d.invoice_number)}${field('ƒå. √∫ƒçtenky',d.receipt_number)}${field('Obj. ƒç√≠slo',d.order_number)}${field('Platba',d.payment_method)}${field('Spoƒæahlivos≈•',d.confidence)}</div></div>
${items}
<div class="detail-grid" style="margin-top:12px"><div class="totals-box"><div class="tot-row"><span>Z√°klad</span><span class="mono">${fmt(d.subtotal)}</span></div>${d.tax_rate?`<div class="tot-row"><span>DPH (${d.tax_rate})</span><span class="mono">${fmt(d.tax_amount)}</span></div>`:''}<div class="tot-row" style="border-top:2px solid var(--border2);padding-top:8px;margin-top:4px;font-weight:700;color:var(--white)"><span>Celkom (${d.currency||'?'})</span><span class="mono" style="color:var(--purple);font-size:16px">${fmt(d.total)}</span></div></div>
${d.notes?`<div class="notes-box"><h4 class="dh4">Pozn√°mky</h4><p style="font-size:13px;color:var(--text2);line-height:1.5">${d.notes}</p></div>`:'<div></div>'}</div></div></div></div>`}

// ===== Edit Mode =====
function startEdit(idx){
editMode=true;const d=results[idx];const rot=d._rotation||0;const isP=d._originalMediaType==='application/pdf';
let orig='<div style="padding:40px;text-align:center;color:var(--text4)">‚Äî</div>';
if(d._originalDataUrl){if(isP)orig=`<iframe src="${d._originalDataUrl}"></iframe>`;else orig=`<img id="orig-img-${idx}" src="${d._originalDataUrl}" style="transform:rotate(${rot}deg)">`}
const rotC=!isP&&d._originalDataUrl?`<div class="rot-controls"><button class="rot-btn" onclick="event.stopPropagation();rotImg(${idx},-90)">‚Ü∂</button><button class="rot-btn" onclick="event.stopPropagation();rotImg(${idx},90)">‚Ü∑</button><button class="rot-btn" onclick="event.stopPropagation();rotImg(${idx},180)">‚áÖ</button></div>`:'';

let itemsEdit='';if(d.items){itemsEdit=d.items.map((it,ii)=>`<div class="item-row-edit" data-item="${ii}"><input data-f="description" value="${it.description||''}"><input data-f="quantity" value="${it.quantity||1}" style="text-align:right"><input data-f="unit_price" value="${it.unit_price||0}" style="text-align:right"><input data-f="total" value="${it.total||0}" style="text-align:right"><button class="item-del" onclick="removeItem(${ii})">√ó</button></div>`).join('')}

$('detailPanel').innerHTML=`<div class="detail">
<div class="edit-toolbar"><span class="info">‚úèÔ∏è Re≈æim √∫prav ‚Äî opravte ƒço AI nepreƒç√≠talo spr√°vne</span><button class="btn-sm btn-save" onclick="saveEdit(${idx})">üíæ Ulo≈æi≈•</button><button class="btn-sm btn-cancel" onclick="renderDetail(${idx});editMode=false">Zru≈°i≈•</button></div>
<div class="detail-split"><div class="detail-original"><div class="detail-original-head"><span class="dh4" style="margin:0">Origin√°l</span>${rotC}</div><div class="detail-original-body">${orig}</div></div>
<div class="detail-data" id="editForm">
<div class="detail-grid"><div><h4 class="dh4">Dod√°vateƒæ</h4>${eField('N√°zov','vendor',d.vendor)}${eField('Adresa','vendor_address',d.vendor_address)}${eField('IƒåO','ico',d.ico)}${eField('DIƒå','dic',d.dic)}${eField('Iƒå DPH','ic_dph',d.ic_dph)}${eField('IBAN','iban',d.iban)}</div>
<div><h4 class="dh4">Dokument</h4>${eField('D√°tum','date',d.date)}${eField('Splatnos≈•','due_date',d.due_date)}${eField('ƒå. dokladu','invoice_number',d.invoice_number)}${eField('ƒå. √∫ƒçtenky','receipt_number',d.receipt_number)}${eField('Platba','payment_method',d.payment_method)}${eField('Mena','currency',d.currency)}</div></div>
<div style="margin-top:16px"><h4 class="dh4">Polo≈æky</h4>
<div style="display:grid;grid-template-columns:1fr 60px 80px 80px 30px;gap:6px;margin-bottom:4px;font-size:10px;color:var(--text4);text-transform:uppercase"><span>Popis</span><span style="text-align:right">Mn.</span><span style="text-align:right">Jedn.</span><span style="text-align:right">Spolu</span><span></span></div>
<div id="itemsContainer">${itemsEdit}</div>
<button class="btn-add" onclick="addItem()">+ Prida≈• polo≈æku</button></div>
<div class="detail-grid" style="margin-top:16px"><div><h4 class="dh4">Sumy</h4>${eField('Z√°klad','subtotal',d.subtotal,'sm')}${eField('DPH sadzba','tax_rate',d.tax_rate,'sm')}${eField('DPH suma','tax_amount',d.tax_amount,'sm')}${eField('Celkom','total',d.total,'sm')}</div>
<div><h4 class="dh4">Pozn√°mky</h4><textarea data-key="notes" class="edit-input" style="height:100px;resize:vertical">${d.notes||''}</textarea></div></div>
</div></div></div>`}

function addItem(){const c=$('itemsContainer');const n=c.children.length;
c.insertAdjacentHTML('beforeend',`<div class="item-row-edit" data-item="${n}"><input data-f="description" value="" placeholder="Popis"><input data-f="quantity" value="1" style="text-align:right"><input data-f="unit_price" value="0" style="text-align:right"><input data-f="total" value="0" style="text-align:right"><button class="item-del" onclick="this.parentElement.remove()">√ó</button></div>`)}
function removeItem(ii){const rows=document.querySelectorAll('.item-row-edit');if(rows[ii])rows[ii].remove()}

async function saveEdit(idx){
const d=results[idx];const form=$('editForm');
// Read simple fields
form.querySelectorAll('.edit-input[data-key]').forEach(inp=>{const k=inp.dataset.key,v=inp.value.trim();
if(['subtotal','tax_amount','total'].includes(k))d[k]=v?parseFloat(v.replace(',','.')):null;
else d[k]=v||null});
// Read textarea
const ta=form.querySelector('textarea[data-key]');if(ta)d[ta.dataset.key]=ta.value.trim()||null;
// Read items
const items=[];document.querySelectorAll('.item-row-edit').forEach(row=>{const desc=row.querySelector('[data-f="description"]')?.value?.trim();
if(!desc)return;items.push({description:desc,quantity:parseFloat(row.querySelector('[data-f="quantity"]')?.value)||1,unit_price:parseFloat(row.querySelector('[data-f="unit_price"]')?.value?.replace(',','.'))||0,total:parseFloat(row.querySelector('[data-f="total"]')?.value?.replace(',','.'))||0})});
d.items=items;d.confidence='edited';
try{if(d.id)await dbUpdate({...d})}catch(e){console.warn('DB update failed',e)}
editMode=false;renderDetail(idx);showResults()}

async function deleteInvoice(idx){if(!confirm('Zmaza≈• tento doklad?'))return;
const d=results[idx];if(d.id)try{await dbDelete(d.id)}catch(e){}
results.splice(idx,1);selectedIdx=null;$('detailPanel').innerHTML='';showResults();updateDbBar()}

function rotImg(idx,deg){const d=results[idx];d._rotation=((d._rotation||0)+deg+360)%360;if(d.id)dbUpdate({...d}).catch(()=>{});const img=$('orig-img-'+idx);if(img)img.style.transform='rotate('+d._rotation+'deg)'}

// ===== Excel =====
function generateExcel(){if(!results.length)return;const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(results.map(r=>({'S√∫bor':r._displayName||r._filename,'Dod√°vateƒæ':r.vendor||'','D√°tum':r.date||'','ƒå. dokladu':r.invoice_number||'','ƒå. √∫ƒçtenky':r.receipt_number||'','IƒåO':r.ico||'','DIƒå':r.dic||'','Iƒå DPH':r.ic_dph||'','IBAN':r.iban||'','Mena':r.currency||'','Z√°klad':r.subtotal??'','DPH':r.tax_rate||'','DPH suma':r.tax_amount??'','Celkom':r.total??'','Platba':r.payment_method||'','Adresa':r.vendor_address||'','Pozn√°mky':r.notes||''}))),'Prehƒæad');
const it=[];results.forEach(r=>(r.items||[]).forEach(i=>it.push({'S√∫bor':r._displayName||r._filename,'Dod√°vateƒæ':r.vendor||'','D√°tum':r.date||'','Polo≈æka':i.description||'','Mn.':i.quantity??'','Jedn.':i.unit_price??'','Spolu':i.total??'','Mena':r.currency||''})));
if(it.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(it),'Polo≈æky');
const vm=new Map();results.forEach(r=>{const k=r.vendor||'?';if(!vm.has(k))vm.set(k,{Dod√°vateƒæ:k,IƒåO:r.ico||'',Poƒçet:0,Suma:0,Mena:r.currency||''});const v=vm.get(k);v.Poƒçet++;v.Suma+=r.total||0});
XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet([...vm.values()]),'Dod√°vatelia');
XLSX.writeFile(wb,`faktury_${new Date().toISOString().split('T')[0]}.xlsx`)}

// ===== HTML Report =====
function generateHtmlReport(){if(!results.length)return;
const ts=results.reduce((s,r)=>s+(r.total||0),0);const cur=[...new Set(results.map(r=>r.currency).filter(Boolean))];
const td=cur.length<=1?`${fmt(ts)} ${cur[0]||''}`:cur.map(c=>`${fmt(results.filter(r=>r.currency===c).reduce((s,r)=>s+(r.total||0),0))} ${c}`).join(' ¬∑ ');
const rf=(l,v)=>v!=null&&v!==''?`<div style="display:flex;gap:6px;margin-bottom:3px"><span style="font-size:12px;color:#4e5268;min-width:70px">${l}</span><span style="font-size:13px;color:#cdd0dc">${v}</span></div>`:'';
const cc={high:'#22c55e',medium:'#eab308',low:'#ef4444',edited:'#60a5fa'};
const pages=results.map((d,idx)=>{const rot=d._rotation||0;const rotS=rot?`transform:rotate(${rot}deg);`:'';
let orig='';if(d._originalDataUrl){orig=d._originalMediaType==='application/pdf'?`<iframe src="${d._originalDataUrl}" style="width:100%;height:600px;border:none"></iframe>`:`<img src="${d._originalDataUrl}" style="max-width:100%;border-radius:8px;${rotS}">`}
let items='';if(d.items?.length){items=`<h4 style="margin:16px 0 8px;font-size:11px;color:#636987;text-transform:uppercase;font-weight:600">Polo≈æky (${d.items.length})</h4><table style="width:100%;border-collapse:collapse;font-size:13px;border:1px solid #1c1e2e"><thead><tr><th style="text-align:left;padding:8px 12px;background:#181926;color:#636987;font-size:11px;text-transform:uppercase;border-bottom:1px solid #1c1e2e">Popis</th><th style="text-align:right;padding:8px 12px;background:#181926;color:#636987;font-size:11px;border-bottom:1px solid #1c1e2e">Mn.</th><th style="text-align:right;padding:8px 12px;background:#181926;color:#636987;font-size:11px;border-bottom:1px solid #1c1e2e">Jedn.</th><th style="text-align:right;padding:8px 12px;background:#181926;color:#636987;font-size:11px;border-bottom:1px solid #1c1e2e">Spolu</th></tr></thead><tbody>${d.items.map(i=>`<tr><td style="padding:7px 12px;border-bottom:1px solid #141520">${i.description}</td><td style="padding:7px 12px;border-bottom:1px solid #141520;text-align:right;font-family:monospace">${i.quantity}</td><td style="padding:7px 12px;border-bottom:1px solid #141520;text-align:right;font-family:monospace">${fmt(i.unit_price)}</td><td style="padding:7px 12px;border-bottom:1px solid #141520;text-align:right;font-weight:600;font-family:monospace">${fmt(i.total)}</td></tr>`).join('')}</tbody></table>`}
return`<div id="inv-${idx}" style="background:#13141d;border:1px solid #1c1e2e;border-radius:14px;margin-bottom:24px;overflow:hidden;page-break-inside:avoid"><div style="padding:20px 24px;display:flex;justify-content:space-between;align-items:flex-start;border-bottom:1px solid #1c1e2e;flex-wrap:wrap;gap:12px"><div><h2 style="font-size:20px;font-weight:700;color:#f0f0f0;margin:0">${d.vendor||'‚Äî'}</h2><div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">${d.date?`<span style="font-size:12px;padding:2px 10px;border-radius:6px;background:#1a1d2e;color:#636987;font-family:monospace">${d.date}</span>`:''}${d.invoice_number?`<span style="font-size:12px;padding:2px 10px;border-radius:6px;background:#1a1d2e;color:#636987;font-family:monospace">#${d.invoice_number}</span>`:''}<span style="font-size:11px;font-weight:600;color:${cc[d.confidence]||'#666'}">${d.confidence||''}</span></div></div><div style="text-align:right"><div style="font-size:11px;color:#636987;text-transform:uppercase">Celkom</div><div style="font-size:24px;font-weight:700;color:#a78bfa;font-family:monospace">${fmt(d.total)} ${d.currency||''}</div></div></div><div style="display:grid;grid-template-columns:1fr 1fr"><div style="border-right:1px solid #1c1e2e;padding:16px;background:#0f1017;display:flex;align-items:flex-start;justify-content:center">${orig}</div><div style="padding:20px"><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px"><div>${rf('N√°zov',d.vendor)}${rf('Adresa',d.vendor_address)}${rf('IƒåO',d.ico)}${rf('DIƒå',d.dic)}${rf('Iƒå DPH',d.ic_dph)}${rf('IBAN',d.iban)}</div><div>${rf('D√°tum',d.date)}${rf('ƒå. dokladu',d.invoice_number)}${rf('ƒå. √∫ƒçtenky',d.receipt_number)}${rf('Platba',d.payment_method)}</div></div>${items}<div style="background:#181926;border-radius:10px;padding:14px 16px;border:1px solid #1c1e2e;margin-top:12px"><div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#8b8fa3"><span>Z√°klad</span><span style="font-family:monospace">${fmt(d.subtotal)}</span></div>${d.tax_rate?`<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;color:#8b8fa3"><span>DPH (${d.tax_rate})</span><span style="font-family:monospace">${fmt(d.tax_amount)}</span></div>`:''}<div style="display:flex;justify-content:space-between;padding:8px 0 0;color:#f0f0f0;font-weight:700;border-top:2px solid #252838;margin-top:4px"><span>Celkom</span><span style="font-family:monospace;color:#a78bfa;font-size:16px">${fmt(d.total)}</span></div></div></div></div></div>`}).join('');

const toc=results.map((r,i)=>`<tr onclick="document.getElementById('inv-${i}').scrollIntoView({behavior:'smooth'})" style="cursor:pointer"><td style="padding:9px 14px;border-bottom:1px solid #141520;font-family:monospace;font-size:12px">${r._displayName||r._filename}</td><td style="padding:9px 14px;border-bottom:1px solid #141520">${r.vendor||'‚Äî'}</td><td style="padding:9px 14px;border-bottom:1px solid #141520;font-family:monospace;font-size:12px">${r.date||'‚Äî'}</td><td style="padding:9px 14px;border-bottom:1px solid #141520;text-align:right;font-weight:600;font-family:monospace;font-size:12px">${fmt(r.total)}</td><td style="padding:9px 14px;border-bottom:1px solid #141520">${r.currency||''}</td></tr>`).join('');

const html=`<!DOCTYPE html><html lang="sk"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Fakt√∫ry ${new Date().toISOString().split('T')[0]}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;background:#0f1017;color:#cdd0dc;padding:32px 24px}.w{max-width:1100px;margin:0 auto}@media(max-width:800px){[style*="grid-template-columns: 1fr 1fr"],[style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr!important}}@media print{body{background:#fff;color:#333}}</style></head><body><div class="w"><h1 style="font-size:24px;font-weight:700;color:#f0f0f0;margin-bottom:4px">Fakt√∫ry ‚Äî Report</h1><p style="font-size:13px;color:#636987;margin-bottom:24px">${new Date().toLocaleString('sk-SK')} ¬∑ ${results.length} dokladov</p><div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap"><div style="background:#13141d;border:1px solid #1c1e2e;border-radius:10px;padding:14px 18px;flex:1;min-width:100px"><div style="font-size:22px;font-weight:700;color:#f0f0f0;font-family:monospace">${results.length}</div><div style="font-size:11px;color:#636987;text-transform:uppercase">Dokladov</div></div><div style="background:#13141d;border:1px solid #1c1e2e;border-radius:10px;padding:14px 18px;flex:1.5;min-width:100px"><div style="font-size:22px;font-weight:700;color:#a78bfa;font-family:monospace">${td}</div><div style="font-size:11px;color:#636987;text-transform:uppercase">Celkom</div></div></div><div style="background:#13141d;border:1px solid #1c1e2e;border-radius:12px;overflow:auto;margin-bottom:32px"><table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr><th style="text-align:left;padding:10px 14px;background:#181926;color:#636987;font-size:11px;text-transform:uppercase;border-bottom:1px solid #1c1e2e">S√∫bor</th><th style="text-align:left;padding:10px 14px;background:#181926;color:#636987;font-size:11px;text-transform:uppercase;border-bottom:1px solid #1c1e2e">Dod√°vateƒæ</th><th style="text-align:left;padding:10px 14px;background:#181926;color:#636987;font-size:11px;text-transform:uppercase;border-bottom:1px solid #1c1e2e">D√°tum</th><th style="text-align:right;padding:10px 14px;background:#181926;color:#636987;font-size:11px;text-transform:uppercase;border-bottom:1px solid #1c1e2e">Celkom</th><th style="text-align:left;padding:10px 14px;background:#181926;color:#636987;font-size:11px;text-transform:uppercase;border-bottom:1px solid #1c1e2e">Mena</th></tr></thead><tbody>${toc}</tbody></table></div>${pages}</div></body></html>`;
const blob=new Blob([html],{type:'text/html;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`faktury_${new Date().toISOString().split('T')[0]}.html`;a.click();URL.revokeObjectURL(a.href)}

function resetAll(){files=[];results=[];fileErrors=[];selectedIdx=null;editMode=false;aborted=false;$('dropZone').classList.remove('hidden');$('processPanel').classList.add('hidden');$('resultsSection').classList.add('hidden');$('resetBtn').classList.add('hidden');$('progressWrap').classList.add('hidden');$('startBtn').classList.remove('hidden');$('stopBtn').classList.add('hidden');$('fileInput').value='';$('detailPanel').innerHTML=''}
const $=id=>document.getElementById(id);
updateDbBar();
</script>
</body>
</html>
